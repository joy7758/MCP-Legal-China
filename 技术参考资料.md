# ğŸ”§ MCP-Legal-China æŠ€æœ¯å‚è€ƒèµ„æ–™

## ğŸ“š MCP (Model Context Protocol) æ ¸å¿ƒçŸ¥è¯†

### ä»€ä¹ˆæ˜¯ MCP?
MCP æ˜¯ Anthropic å¼€å‘çš„å¼€æ”¾æ ‡å‡†åè®®,ç”¨äºå®ç° LLM ä¸å¤–éƒ¨åº”ç”¨ä¹‹é—´çš„å®‰å…¨ã€æ ‡å‡†åŒ–äº¤äº’ã€‚å®ƒå°±åƒæ˜¯ AI å·¥å…·çš„"é€šç”¨é€‚é…å™¨"ã€‚

### MCP ä¸‰å¤§æ ¸å¿ƒæ¦‚å¿µ

#### 1. Tools (å·¥å…·)
- **ä½œç”¨**: å…è®¸ LLM æ‰§è¡Œå¤–éƒ¨åŠŸèƒ½
- **ç±»æ¯”**: ç±»ä¼¼äº Web API çš„ `POST` ç«¯ç‚¹
- **ç¤ºä¾‹**: æŸ¥è¯¢ä¼ä¸šé£é™©ä¿¡æ¯ã€ç”ŸæˆåˆåŒå®¡æŸ¥æŠ¥å‘Š

#### 2. Resources (èµ„æº)
- **ä½œç”¨**: æš´éœ²æ•°æ®å’Œå†…å®¹ä¾› LLM è¯»å–å’Œä½¿ç”¨
- **ç±»æ¯”**: ç±»ä¼¼äº Web API çš„ `GET` ç«¯ç‚¹
- **ç¤ºä¾‹**: ã€Šæ°‘æ³•å…¸ã€‹æ¡æ–‡åº“ã€åˆåŒæ¨¡æ¿åº“

#### 3. Prompts (æç¤ºè¯)
- **ä½œç”¨**: å®šä¹‰å¯é‡ç”¨çš„æç¤ºè¯æ¨¡æ¿å’Œå·¥ä½œæµ
- **ç¤ºä¾‹**: åˆåŒå®¡æŸ¥æµç¨‹ã€é£é™©è¯„ä¼°æ¨¡æ¿

---

## ğŸ Python MCP SDK ä½¿ç”¨æŒ‡å—

### ç¯å¢ƒè¦æ±‚
- **Python ç‰ˆæœ¬**: 3.10 æˆ–æ›´é«˜
- **åŒ…ç®¡ç†å™¨**: `uv` (æ¨è) æˆ– `pip`
- **æ ¸å¿ƒä¾èµ–**: `mcp` (å®˜æ–¹ SDK)

### ç‰ˆæœ¬è¯´æ˜
- **å½“å‰ç¨³å®šç‰ˆ**: v1.x (æ¨èç”Ÿäº§ç¯å¢ƒä½¿ç”¨)
- **å¼€å‘ç‰ˆ**: v2 (é¢„è®¡ 2026 Q1 å‘å¸ƒ,ç›®å‰å¤„äº pre-alpha)

### å¿«é€Ÿå¼€å§‹: åˆ›å»ºä¸€ä¸ªç®€å•çš„ MCP Server

```python
from mcp.server import Server
from mcp.server.stdio import stdio_server
from mcp.types import Tool, TextContent

# åˆ›å»º MCP Server å®ä¾‹
app = Server("legal-cn-server")

# å®šä¹‰ä¸€ä¸ª Tool
@app.list_tools()
async def list_tools() -> list[Tool]:
    return [
        Tool(
            name="check_contract_risk",
            description="æ£€æŸ¥åˆåŒä¸­çš„æ³•å¾‹é£é™©",
            inputSchema={
                "type": "object",
                "properties": {
                    "contract_text": {
                        "type": "string",
                        "description": "åˆåŒæ–‡æœ¬å†…å®¹"
                    }
                },
                "required": ["contract_text"]
            }
        )
    ]

# å®ç° Tool çš„è°ƒç”¨é€»è¾‘
@app.call_tool()
async def call_tool(name: str, arguments: dict) -> list[TextContent]:
    if name == "check_contract_risk":
        text = arguments["contract_text"]
        # è¿™é‡Œå®ç°ä½ çš„é£é™©æ£€æŸ¥é€»è¾‘
        result = analyze_contract(text)
        return [TextContent(type="text", text=result)]
    
    raise ValueError(f"Unknown tool: {name}")

# å¯åŠ¨æœåŠ¡å™¨
async def main():
    async with stdio_server() as (read_stream, write_stream):
        await app.run(
            read_stream,
            write_stream,
            app.create_initialization_options()
        )

if __name__ == "__main__":
    import asyncio
    asyncio.run(main())
```

### ä½¿ç”¨ FastMCP ç®€åŒ–å¼€å‘

FastMCP æ˜¯ä¸€ä¸ªæ›´ç®€æ´çš„æ¡†æ¶,å¯ä»¥å¿«é€Ÿåˆ›å»º MCP Server:

```python
from fastmcp import FastMCP

# åˆ›å»º FastMCP å®ä¾‹
mcp = FastMCP("Legal-CN-Server")

# ä½¿ç”¨è£…é¥°å™¨å®šä¹‰ Tool
@mcp.tool()
def check_contract_risk(contract_text: str) -> str:
    """
    æ£€æŸ¥åˆåŒä¸­çš„æ³•å¾‹é£é™©
    
    Args:
        contract_text: åˆåŒæ–‡æœ¬å†…å®¹
    
    Returns:
        é£é™©åˆ†ææŠ¥å‘Š
    """
    # å®ç°é£é™©æ£€æŸ¥é€»è¾‘
    if "çº½çº¦" in contract_text or "New York" in contract_text:
        return "ã€é£é™©æç¤ºã€‘æ£€æµ‹åˆ°éä¸­å›½å¢ƒå†…ç®¡è¾–æƒ"
    return "ã€åˆæ­¥æ£€æŸ¥ã€‘æœªå‘ç°æ˜æ˜¾å†²çª"

# å¯åŠ¨æœåŠ¡å™¨
if __name__ == "__main__":
    mcp.run()
```

---

## ğŸ” å¤©çœ¼æŸ¥ API é›†æˆæŒ‡å—

### API åŸºæœ¬ä¿¡æ¯

#### 1. ä¼ä¸šå¤©çœ¼é£é™©æ¥å£
- **æ¥å£ ID**: 1058
- **åŠŸèƒ½**: è·å–ä¼ä¸šè‡ªèº«ã€å‘¨è¾¹å’Œé¢„è­¦é£é™©ä¿¡æ¯
- **è°ƒç”¨ä»·æ ¼**: 0.2å…ƒ/æ¬¡
- **è¯·æ±‚æ–¹å¼**: GET
- **è®¤è¯æ–¹å¼**: Authorization Token

#### 2. å¸æ³•é£é™©æ¥å£
- **æ¥å£ ID**: 1002
- **åŠŸèƒ½**: è·å–æ³•å¾‹è¯‰è®¼ã€æ³•é™¢å…¬å‘Šã€å¤±ä¿¡äººã€è¢«æ‰§è¡Œäººç­‰ä¿¡æ¯
- **è°ƒç”¨ä»·æ ¼**: 1.5å…ƒ/æ¬¡

### è·å– API å¯†é’¥æ­¥éª¤

1. è®¿é—®å¤©çœ¼æŸ¥å¼€æ”¾å¹³å°: https://open.tianyancha.com
2. æ³¨å†Œ/ç™»å½•è´¦å·
3. è¿›å…¥"ä¸ªäººä¸­å¿ƒ" â†’ "æˆ‘çš„æ¥å£"
4. è·å– API Key (Authorization Token)

### API è°ƒç”¨ç¤ºä¾‹

```python
import requests
import os
from typing import Dict, Any

class TianyanchaClient:
    """å¤©çœ¼æŸ¥ API å®¢æˆ·ç«¯"""
    
    def __init__(self, api_key: str):
        self.api_key = api_key
        self.base_url = "https://open.tianyancha.com/services/open"
    
    def get_company_risk(self, company_name: str) -> Dict[str, Any]:
        """
        è·å–ä¼ä¸šé£é™©ä¿¡æ¯
        
        Args:
            company_name: å…¬å¸åç§°
            
        Returns:
            ä¼ä¸šé£é™©æ•°æ® (JSON)
        """
        url = f"{self.base_url}/ic/baseinfo/1058"
        
        headers = {
            "Authorization": self.api_key,
            "Content-Type": "application/json"
        }
        
        params = {
            "keyword": company_name
        }
        
        try:
            response = requests.get(url, headers=headers, params=params, timeout=10)
            response.raise_for_status()
            return response.json()
        
        except requests.exceptions.RequestException as e:
            return {
                "error": True,
                "message": f"API è°ƒç”¨å¤±è´¥: {str(e)}"
            }
    
    def get_judicial_risk(self, company_name: str) -> Dict[str, Any]:
        """
        è·å–å¸æ³•é£é™©ä¿¡æ¯
        
        Args:
            company_name: å…¬å¸åç§°
            
        Returns:
            å¸æ³•é£é™©æ•°æ® (JSON)
        """
        url = f"{self.base_url}/ic/judicial/1002"
        
        headers = {
            "Authorization": self.api_key
        }
        
        params = {
            "keyword": company_name
        }
        
        try:
            response = requests.get(url, headers=headers, params=params, timeout=10)
            response.raise_for_status()
            return response.json()
        
        except requests.exceptions.RequestException as e:
            return {
                "error": True,
                "message": f"API è°ƒç”¨å¤±è´¥: {str(e)}"
            }

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    # ä»ç¯å¢ƒå˜é‡è¯»å– API Key
    api_key = os.getenv("TIANYANCHA_API_KEY")
    
    client = TianyanchaClient(api_key)
    
    # æŸ¥è¯¢ä¼ä¸šé£é™©
    result = client.get_company_risk("åŒ—äº¬å­—èŠ‚è·³åŠ¨ç§‘æŠ€æœ‰é™å…¬å¸")
    print(result)
```

### API è°ƒç”¨æœ€ä½³å®è·µ

#### 1. é”™è¯¯å¤„ç†
```python
def safe_api_call(func):
    """API è°ƒç”¨è£…é¥°å™¨,å¤„ç†å¸¸è§é”™è¯¯"""
    def wrapper(*args, **kwargs):
        try:
            return func(*args, **kwargs)
        except requests.exceptions.Timeout:
            return {"error": "è¯·æ±‚è¶…æ—¶"}
        except requests.exceptions.HTTPError as e:
            return {"error": f"HTTP é”™è¯¯: {e.response.status_code}"}
        except Exception as e:
            return {"error": f"æœªçŸ¥é”™è¯¯: {str(e)}"}
    return wrapper
```

#### 2. é™æµå¤„ç†
```python
import time
from functools import wraps

def rate_limit(max_calls: int, period: int):
    """
    é™æµè£…é¥°å™¨
    
    Args:
        max_calls: æ—¶é—´çª—å£å†…æœ€å¤§è°ƒç”¨æ¬¡æ•°
        period: æ—¶é—´çª—å£(ç§’)
    """
    calls = []
    
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            now = time.time()
            # æ¸…ç†è¿‡æœŸçš„è°ƒç”¨è®°å½•
            calls[:] = [c for c in calls if c > now - period]
            
            if len(calls) >= max_calls:
                sleep_time = period - (now - calls[0])
                time.sleep(sleep_time)
            
            calls.append(time.time())
            return func(*args, **kwargs)
        
        return wrapper
    return decorator

# ä½¿ç”¨ç¤ºä¾‹: æ¯åˆ†é’Ÿæœ€å¤šè°ƒç”¨ 10 æ¬¡
@rate_limit(max_calls=10, period=60)
def call_tianyancha_api(company_name: str):
    # API è°ƒç”¨é€»è¾‘
    pass
```

#### 3. æ•°æ®è„±æ•
```python
def sanitize_company_data(data: Dict[str, Any]) -> Dict[str, Any]:
    """
    æ•°æ®è„±æ•,åªä¿ç•™å…³é”®é£é™©ä¿¡æ¯
    
    Args:
        data: åŸå§‹ API è¿”å›æ•°æ®
        
    Returns:
        è„±æ•åçš„ç²¾ç®€æ•°æ®
    """
    return {
        "company_name": data.get("name", ""),
        "risk_summary": {
            "litigation_count": data.get("litigation_count", 0),
            "dishonest_count": data.get("dishonest_count", 0),
            "abnormal_operation": data.get("abnormal_operation", False)
        },
        "risk_level": calculate_risk_level(data)
    }

def calculate_risk_level(data: Dict[str, Any]) -> str:
    """è®¡ç®—é£é™©ç­‰çº§"""
    litigation = data.get("litigation_count", 0)
    dishonest = data.get("dishonest_count", 0)
    
    if dishonest > 0 or litigation > 10:
        return "é«˜é£é™©"
    elif litigation > 3:
        return "ä¸­é£é™©"
    else:
        return "ä½é£é™©"
```

---

## ğŸ”— å°†å¤©çœ¼æŸ¥é›†æˆåˆ° MCP Tool

### å®Œæ•´ç¤ºä¾‹: `get_company_risk_report` Tool

```python
from fastmcp import FastMCP
from typing import Dict, Any
import os

mcp = FastMCP("Legal-CN-Server")

# åˆå§‹åŒ–å¤©çœ¼æŸ¥å®¢æˆ·ç«¯
tianyancha_client = TianyanchaClient(
    api_key=os.getenv("TIANYANCHA_API_KEY")
)

@mcp.tool()
def get_company_risk_report(company_name: str) -> str:
    """
    è·å–ä¼ä¸šé£é™©æŠ¥å‘Š
    
    Args:
        company_name: å…¬å¸åç§°
        
    Returns:
        ç»“æ„åŒ–çš„é£é™©æŠ¥å‘Š (JSON æ ¼å¼å­—ç¬¦ä¸²)
    """
    # è°ƒç”¨å¤©çœ¼æŸ¥ API
    risk_data = tianyancha_client.get_company_risk(company_name)
    judicial_data = tianyancha_client.get_judicial_risk(company_name)
    
    # å¤„ç†é”™è¯¯
    if risk_data.get("error") or judicial_data.get("error"):
        return json.dumps({
            "error": True,
            "message": "API è°ƒç”¨å¤±è´¥,è¯·æ£€æŸ¥ç½‘ç»œæˆ– API å¯†é’¥"
        }, ensure_ascii=False)
    
    # æ•°æ®è„±æ•å’Œç²¾ç®€
    report = {
        "company_name": company_name,
        "risk_summary": {
            "overall_risk_level": calculate_risk_level(risk_data),
            "litigation_count": judicial_data.get("litigation_count", 0),
            "dishonest_records": judicial_data.get("dishonest_count", 0),
            "abnormal_operations": risk_data.get("abnormal_operation", False)
        },
        "recommendations": generate_recommendations(risk_data, judicial_data)
    }
    
    return json.dumps(report, ensure_ascii=False, indent=2)

def generate_recommendations(risk_data: Dict, judicial_data: Dict) -> list:
    """æ ¹æ®é£é™©æ•°æ®ç”Ÿæˆå»ºè®®"""
    recommendations = []
    
    if judicial_data.get("dishonest_count", 0) > 0:
        recommendations.append("è¯¥ä¼ä¸šå­˜åœ¨å¤±ä¿¡è®°å½•,å»ºè®®è°¨æ…åˆä½œ")
    
    if judicial_data.get("litigation_count", 0) > 5:
        recommendations.append("è¯¥ä¼ä¸šæ¶‰è¯‰è¾ƒå¤š,å»ºè®®æ·±å…¥è°ƒæŸ¥")
    
    if risk_data.get("abnormal_operation"):
        recommendations.append("è¯¥ä¼ä¸šå­˜åœ¨ç»è¥å¼‚å¸¸,å»ºè®®æ ¸å®ç»è¥çŠ¶æ€")
    
    if not recommendations:
        recommendations.append("åˆæ­¥å®¡æŸ¥æœªå‘ç°é‡å¤§é£é™©,å»ºè®®ç»“åˆå…·ä½“ä¸šåŠ¡åœºæ™¯è¯„ä¼°")
    
    return recommendations
```

---

## ğŸ“– å­¦ä¹ èµ„æº

### å®˜æ–¹æ–‡æ¡£
- **MCP å®˜æ–¹æ–‡æ¡£**: https://modelcontextprotocol.info
- **MCP Python SDK**: https://github.com/modelcontextprotocol/python-sdk
- **å¤©çœ¼æŸ¥å¼€æ”¾å¹³å°**: https://open.tianyancha.com

### æ¨èæ•™ç¨‹
- Anthropic MCP è¯¾ç¨‹: https://skilljar.com (æœç´¢ "Model Context Protocol")
- FastMCP å¿«é€Ÿå…¥é—¨: æŸ¥çœ‹ GitHub ä¸Šçš„ FastMCP ç¤ºä¾‹

### å¼€å‘å·¥å…·
- **MCP Inspector**: å¯è§†åŒ–å’Œæµ‹è¯• MCP Server åŠŸèƒ½çš„å·¥å…·

---

## ğŸš€ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **å®‰è£…ä¾èµ–**:
   ```bash
   pip install mcp fastmcp requests python-dotenv
   ```

2. **è·å–å¤©çœ¼æŸ¥ API Key**:
   - è®¿é—® https://open.tianyancha.com
   - æ³¨å†Œå¹¶è·å– API å¯†é’¥

3. **åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶** (`.env`):
   ```
   TIANYANCHA_API_KEY=your_api_key_here
   ```

4. **å¼€å§‹ç¼–ç **!

---

*æœ€åæ›´æ–°: 2026-02-05*
